---
- name: Artifact | Extract artifact archive to working directory
  tags: ["always"]
  command: |
    if [ -f "{{ .artifact_file }}" ]; then
      mkdir -p {{ .binary_dir }}
      tar -zxvf {{ .artifact_file }} -C {{ .binary_dir }}
    fi
  when: .artifact_file | empty | not

- name: Artifact | Download required binaries and images
  when: .artifact_file | empty
  block:
    # Download core binaries
    - include_tasks: download_binary.yaml
    # Download Helm and CNI binaries
    - include_tasks: download_helm.yaml
    # Download remote images to the local images directory
    - name: Download container images
      image:
        pull:
          images_dir: >-
            {{ .binary_dir }}/images/
          manifests: "{{ .image_manifests | toJson }}"
      when:
        - .image_manifests | default list | empty | not

- name: Artifact | Set ownership of working directory to sudo user
  tags: ["always"]
  ignore_errors: true
  command: |
    chown -R ${SUDO_UID}:${SUDO_GID} {{ .work_dir }}
