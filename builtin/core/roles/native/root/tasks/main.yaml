- name: OS | Add sudo secure path
  tags: ["always"]
  command: |
    ADD_PATHS="/usr/local/bin"
    BACKUP_FILE="/etc/sudoers.backup.$(date +%Y%m%d_%H%M%S)"
    cp /etc/sudoers "$BACKUP_FILE"
    echo "tmp file created: $BACKUP_FILE"
    TMP_FILE=$(mktemp /tmp/sudoers_update.XXXXXX)
    chmod 600 "$TMP_FILE"
    cat /etc/sudoers > "$TMP_FILE"
    cleanup() {
        rm -rf "$TMP_FILE"
        rm -rf "$BACKUP_FILE"
        exit
    }
    trap cleanup EXIT INT TERM
    if grep -q "^Defaults.*secure_path" "$TMP_FILE"; then
        EXISTING_PATH=$(grep "^Defaults.*secure_path" "$TMP_FILE" | sed -n 's/.*secure_path="\([^"]*\)".*/\1/p')
        if [ -n "$EXISTING_PATH" ]; then
            NEW_PATH="$EXISTING_PATH"
            IFS_BAK=$IFS
            IFS=':'
            for path in $ADD_PATHS; do
                if [[ ":$NEW_PATH:" != *":$path:"* ]]; then
                    NEW_PATH="$NEW_PATH:$path"
                fi
            done
            IFS=$IFS_BAK
            sed -i "s|^Defaults.*secure_path=.*|Defaults secure_path=\"$NEW_PATH\"|" "$TMP_FILE"
            echo "already updated secure_path: $NEW_PATH"
        fi
    else
        echo "Defaults secure_path=\"$ADD_PATHS\"" >> "$TMP_FILE"
        echo "already added secure_path: $ADD_PATHS"
    fi
    if visudo -cf "$TMP_FILE"; then
        cp "$TMP_FILE" /etc/sudoers
        chmod 440 /etc/sudoers
        echo "already updated /etc/sudoers"
    else
        echo "something went wrong ,file roll back"
        cp "$BACKUP_FILE" /etc/sudoers
        chmod 440 /etc/sudoers
        echo "already roll back"
        exit 1
    fi
    echo "finish"
