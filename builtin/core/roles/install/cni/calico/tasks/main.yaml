---
- name: Calico | calico-check-calicoctl-installed
  ignore_errors: true
  command: calicoctl version
  register: calicoctl_install_version
  register_type: yaml

- name: Calico | calico-install-calicoctl-if-missing
  when: .calicoctl_install_version.error | empty | not
  block:
    - name: Calico | calico-sync-calicoctl-to-remote
      copy:
        src: >-
          {{ .binary_dir }}/cni/calico/{{ .calico_version }}/{{ .binary_type }}/calicoctl
        dest: /usr/local/bin/calicoctl
        mode: 0755

- name: Calico | calico-sync-calico-package-to-remote
  copy:
    src: >-
      {{ .binary_dir }}/cni/calico/tigera-operator-{{ .calico_version }}.tgz
    dest: >-
      /etc/kubernetes/cni/tigera-operator-{{ .calico_version }}.tgz

- name: Calico | calico-generate-custom-values-file
  copy:
    content: |
      {{ .cni.calico.values }}
    dest: /etc/kubernetes/cni/calico-values.yaml

- name: Calico | calico-apply-helm-chart
  command: |
    helm upgrade --install --create-namespace --namespace tigera-operator calico /etc/kubernetes/cni/tigera-operator-{{ .calico_version }}.tgz -f /etc/kubernetes/cni/calico-values.yaml
