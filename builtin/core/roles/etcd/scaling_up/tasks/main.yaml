- name: ScalingUp | Restart etcd cluster on existing members
  when: 
    - .etcd_install_LoadState.stdout | eq "loaded"
  block:
    - name: ScalingUp | Restart the etcd service
      command: |
        systemctl restart etcd.service
    - name: ScalingUp | Ensure etcd service becomes healthy
      command: |
        for ((i=1; i<=12; i++)); do
          if ETCDCTL_API=3 etcdctl \
            --endpoints=https://localhost:2379 \
            --cacert=/etc/ssl/etcd/ssl/ca.crt \
            --cert=/etc/ssl/etcd/ssl/server.crt \
            --key=/etc/ssl/etcd/ssl/server.key \
            endpoint health >/dev/null 2>&1; then
            echo "✅ etcd is healthy"
            exit 0
          fi
          sleep 5
        done
        echo "❌ etcd did not become healthy within 1 minute"
        exit 1

- name: ScalingUp | Add new etcd member from a node where etcd is not yet installed
  when: 
    - .etcd_install_LoadState.stdout | eq "not-found"
    - .need_installed_etcd | fromJson | has .inventory_hostname
  delegate_to: "{{ .installed_etcd }}"
  command: |
    ETCDCTL_API=3 etcdctl \
      --endpoints=https://localhost:2379 \
      --cacert=/etc/ssl/etcd/ssl/ca.crt \
      --cert=/etc/ssl/etcd/ssl/server.crt \
      --key=/etc/ssl/etcd/ssl/server.key \
      member add {{ .hostname }}