- include_tasks: install_binaries.yaml

- include_tasks: high-availability/main.yaml

- name: Add kube user
  command: |
    useradd -M -c 'Kubernetes user' -s /sbin/nologin -r kube || :

- name: Create kube directories
  command: |
    if [ ! -d "{{ .item.path }}" ]; then
      mkdir -p {{ .item.path }} && chown kube -R {{ .item.chown }}
    fi
  loop:
    - {path: "/usr/local/bin", chown: "/usr/local/bin"}
    - {path: "/etc/kubernetes", chown: "/etc/kubernetes"}
    - {path: "/etc/kubernetes/pki", chown: "/etc/kubernetes/pki"}
    - {path: "/etc/kubernetes/manifests", chown: "/etc/kubernetes/manifests"}
    - {path: "/usr/local/bin/kube-scripts", chown: "/usr/local/bin/kube-scripts"}
    - {path: "/usr/libexec/kubernetes/kubelet-plugins/volume/exec", chown: "/usr/libexec/kubernetes"}
    - {path: "/etc/cni/net.d", chown: "/etc/cni"}
    - {path: "/opt/cni/bin", chown: "/opt/cni"}
    - {path: "/var/lib/calico", chown: "/var/lib/calico"}

- name: Sync audit policy file to remote
  copy:
    src: audit
    dest: /etc/kubernetes/audit/
  when: .kubernetes.audit

- name: Sync ca file to kube_control_plane
  when: 
    - .kubernetes.certs.ca_cert | empty | not
    - .kubernetes.certs.ca_key | empty | not
    - .groups.kube_control_plane | has .inventory_hostname
  block:
    - name: Sync ca cert to kube_control_plane
      copy: 
        src: >-
          {{ .kubernetes.certs.ca_cert }}
        dest: /etc/kubernetes/pki/ca.crt
    - name: Sync ca key to kube_control_plane
      copy:
        src: >-
          {{ .kubernetes.certs.ca_key }}
        dest: /etc/kubernetes/pki/ca.key

- name: Sync front-proxy ca file to kube_control_plane
  when:
    - .kubernetes.certs.front_proxy_cert | empty | not
    - .kubernetes.certs.front_proxy_key | empty | not
    - .groups.kube_control_plane | has .inventory_hostname
  block:
    - name: Sync front-proxy cert to kube_control_plane
      copy: 
        src: >-
          {{ .kubernetes.certs.front_proxy_cert }}
        dest: /etc/kubernetes/pki/front-proxy-ca.crt
    - name: Sync front-proxy key to kube_control_plane
      copy:
        src: >-
          {{ .kubernetes.certs.front_proxy_key }}
        dest: /etc/kubernetes/pki/front-proxy-ca.key