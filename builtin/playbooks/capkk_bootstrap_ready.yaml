---
- name: CNI Binary Install Pre-Check
  hosts:
    - k8s_cluster
  gather_facts: true
  vars_files:
    - vars/cluster_requirements.yaml
  tasks:
    - name: Stop if arch supported
      assert:
        that: or (.cluster_require.supported_architectures.amd64 | has .os.architecture) (.cluster_require.supported_architectures.arm64 | has .os.architecture)
        success_msg: |
          {{- if .cluster_require.supported_architectures.amd64 | has .os.architecture }}
          amd64
          {{- else }}
          arm64
          {{- end }}
        fail_msg: "{{ .os.architecture }} is not a known arch"
      register: binary_type

- name: Kubernetes Install
  hosts:
    - k8s_cluster
  vars_files:
    - vars/create_cluster_kubernetes.yaml
  roles:
    - install/cri
    - capkk/install/kubernetes

- name: Certs Distribution
  hosts:
    - kube_control_plane
  roles:
    - role: install/certs
      when: .renew_certs.enabled

- name: Install CNI
  hosts:
    - kube_control_plane|random
  roles:
    - addons/cni
    - addons/kata
    - addons/nfd
    - addons/sc

- import_playbook: hook/post_install.yaml